# Codex 菜单栏下拉功能需求文档（V1）

## 1. 背景与目标
- 目标产品：macOS 菜单栏常驻应用（Menu Bar App）。
- 当前仅支持启动 Codex App Mac 桌面版。
- 目标能力：在菜单栏下拉中完成模式切换、API 代理配置、模型拉取、思考强度选择，并启动 Codex。

## 2. 需求范围
- 本文仅覆盖“点击工具栏图标后，下拉界面”的功能。
- 不包含多平台支持。
- 不包含其他 AI 客户端支持。

## 3. 用户流程
1. 用户点击菜单栏图标，打开下拉面板。
2. 用户选择模式：原版 或 API 代理版。
3. 若为原版，用户可直接点击“启动 Codex”。
4. 若为 API 代理版，用户输入 BaseUrl、APIKey，点击“测试”。
5. 测试成功后自动拉取模型列表，用户选择模型与思考强度。
6. 用户点击“启动 Codex”。

## 4. 功能需求

### 4.1 模式切换
- 控件：模式选择器（单选）。
- 可选值：原版、API 代理版。
- 默认值：原版。
- 行为：切换到 API 代理版时展示代理配置区域；切回原版时隐藏该区域。

### 4.2 API 代理配置区（仅 API 代理版显示）
- 输入项：BaseUrl（文本输入）。
- 输入项：APIKey（密码输入，支持粘贴）。
- 操作项：测试按钮。
- 字段持久化策略：由实现层定义（建议与安全策略文档一致）。

### 4.3 测试连接与模型拉取
- 触发条件：点击“测试”。
- 调用方式：基于 OpenAI 兼容接口拉取模型。
- 推荐接口：GET {BaseUrl}/models（或按 BaseUrl 规范补齐 /v1/models）。
- 请求头：Authorization: Bearer {APIKey}。
- 成功结果：展示“连接成功”，并填充模型下拉选项（使用 data[].id）。
- 失败结果：展示明确错误信息（网络错误、401/403、404、解析失败等）。

### 4.4 模型选择与思考强度
- 控件：模型下拉（来源于测试成功后的模型列表）。
- 控件：思考强度下拉。
- 思考强度选项：minimal、low、medium、high（默认 medium）。
- 依赖关系：模型未加载前，模型下拉与思考强度置灰。

### 4.5 启动 Codex
- 按钮：启动 Codex。
- 原版模式：直接启动已安装的 Codex App。
- API 代理版模式：使用当前 BaseUrl、APIKey、模型、思考强度作为启动配置后再启动。
- 按钮可用性：
  - 原版：始终可点击。
  - API 代理版：需 BaseUrl、APIKey、模型都有效后可点击。

## 5. 交互与状态要求
- 状态：idle、testing、testSuccess、testFailed、launching、launchFailed。
- testing/launching 状态下按钮显示 loading，避免重复点击。
- 错误提示需可读、可重试，不得静默失败。

## 6. 输入校验
- BaseUrl 必须为合法 URL。
- APIKey 不能为空。
- API 代理模式下必须已选择模型。
- 校验失败时给出就地错误提示，并禁用启动按钮。

## 7. 验收标准（DoD）
1. 下拉面板可切换原版/API 代理版，显示逻辑正确。
2. API 代理版可输入 BaseUrl/APIKey 并执行测试。
3. 测试成功后可自动加载模型列表并可选择思考强度。
4. 启动按钮启用/禁用逻辑符合规则。
5. 任一失败场景有明确错误提示且可重试。
6. 原版与 API 代理版均可触发启动 Codex。

## 8. 非目标（V1 不做）
- 多客户端支持（除 Codex 外）。
- 高级代理规则（多 BaseUrl 路由、模型映射策略）。
- 历史配置管理与多配置档切换。
